<html>
	<head>
		<title>Grafos</title>
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="resources/css/app.css">
		<script type="text/javascript" src="resources/libraries/jquery.js"></script>
		<script type="text/javascript" src="resources/libraries/jcanvas.js"></script>
	</head>
	<body>

		<div id="dados">

			<div class="parte">
				<label for="dinamico">Inclusão dinâmica</label>
				<input type="radio" name="tipoInclusao" value="0" checked>
				<label for="arquivo">Arquivo</label>
				<input type="radio" name="tipoInclusao" value="1">
			</div>

			<div class="parte" id="dinamico">
				<label for="inserirVertice">Inserir vértice</label>
				<br />
				<input type="button" id="inserirVertice" value="Add">
			</div>

			<div class="parte" id="arquivo">
				<label for="inserirArquivo">Inserir arquivo</label>
				<br />
				<input type="file" id="inserirArquivo" value="Add" onchange="pegaArquivo(this)">
			</div>

			<div class="parte requisito" id="remover">
				<label>Remover Vértice</label>
				<br />
				<select name="vertices"></select>
				<input type="button" id="removerVertice" value="Remover">
			</div>

			<div class="parte requisito" id="arestas">
				<label>Inserir Aresta entre os vértices</label>
				<br />
				<label for="aresta1" id="aresta1">Aresta 1</label>
				<select name="aresta1"></select>
				<label for="aresta2">Aresta 2</label>
				<select name="aresta2" id="aresta2"></select>
				<input type="button" id="inserirAresta" value="Add">
			</div>

			<div class="parte requisito" id="removerArestas">
				<label>Remover Aresta entre os vértices</label>
				<br />
				<label for="aresta1" id="aresta1">Aresta 1</label>
				<select name="aresta1"></select>
				<label for="aresta2">Aresta 2</label>
				<select name="aresta2" id="aresta2"></select>
				<input type="button" id="remvoerAresta" value="Remover">
			</div>

			<div class="parte requisito" id="existencia">
				<label>Verificar aresta entre dois vértices</label>
				<br />
				<label for="aresta1" id="aresta1">Aresta 1</label>
				<select name="aresta1"></select>
				<label for="aresta2">Aresta 2</label>
				<select name="aresta2" id="aresta2"></select>
				<input type="button" id="verificarExistencia" value="Verificar">
			</div>

			<div class="parte requisito" id="adjacentes">
				<label>Vértices adjacentes</label>
				<br />
				<select name="vertices"></select>
				<input type="button" id="verificarAdjacentes" value="Verificar">
			</div>

			<div class="parte requisito" id="grau">
				<label>Verificar grau do vértice</label>
				<br />
				<select name="vertices"></select>
				<input type="button" id="verificarGrau" value="Verificar">
			</div>

			<div class="parte requisito" id="obterGraus">
				<label>Obter graus</label>
				<br />
				<input type="button" id="verificarGraus" value="Verificar">
			</div>

			<div class="parte requisito" id="euler">
				<label>Verificar caminho de Euler</label>
				<br />
				<input type="button" id="verificarEuler" value="Verificar">
			</div>

			<div class="parte requisito" id="incidencias">
				<label>Matriz de Adjacências</label>
			</div>

			<div class="parte requisito" id="conexo">
				<label>Verificar Grafo conexo</label>
				<br />
				<input type="button" id="verificarGrafoConexo" value="Verificar">
			</div>

		</div>

		<div class="plotagem">
			<canvas id="canvas" width="1000" height="500" ></canvas>
		</div>

		<div id="infos">

		</div>

	</body>

</html>

<script type="text/javascript">

	var vertices = 0;
	var arestas = '';
	var verificacao = '';
	var adjacentes = '';
	var adjacentesStart = '';

	$('.requisito, #arquivo').hide();

	$('input[name="tipoInclusao"]').on('change', function() {
		if ($(this).val() == 0) {
			$('#arquivo').hide();
			$('#dinamico').show();
		}else {
			$('#arquivo').show();
			$('#dinamico').hide();
		}
	});

	$('#inserirVertice').on('click', function() {
		inserirVertice();
	});

	$('#removerVertice').on('click', function() {
		removerVertice($('#remover select[name="vertices"]').val());
	});

	$('#inserirAresta').on('click', function() {
		inserirAresta($('#arestas select[name="aresta1"]').val(), $('#arestas select[name="aresta2"]').val());
	});

	$('#remvoerAresta').on('click', function() {
		removerAresta($('#removerArestas select[name="aresta1"]').val(), $('#removerArestas select[name="aresta2"]').val());
	});

	$('#verificarExistencia').on('click', function() {
		verificarExistencia($('#existencia select[name="aresta1"]').val(), $('#existencia select[name="aresta2"]').val());
	});	

	$('#verificarAdjacentes').on('click', function() {
		verificarAdjacentes($('#adjacentes select[name="vertices"]').val(), false);
	});

	$('#verificarGrau').on('click', function() {
		verificarGrau($('#grau select[name="vertices"]').val());
	});

	$('#verificarGraus').on('click', function() {
		verificarGraus();
	});

	$('#verificarEuler').on('click', function() {
		euler();
	});

	/*$('#gerarMatriz').on('click', function() {
		matriz();
	});*/

	$('#verificarGrafoConexo').on('click', function() {
		verificarGrafoConexo(false);
	});

	function verificarGraus() {
		clearVariables();

		var grauMaximo = 0;
		var grauMaximoNome = '';

		var grauMinimo = 100;
		var grauMinimoNome = '';

		var grauMedio = 0;

		var verificacaoArestas = arestas.split(',');
		$('#grau select[name="vertices"] option').each(function(i, v) {
			var grauStart = $(v).prop('value');
			var grau = 0;
			
			for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
				grau += getGrauByAresta(verificacaoArestas[c], grauStart);
			}

			grauMedio += grau;

			if (i == 0) {
				grauMaximo = grau;
				grauMaximoNome = $(v).text();

				grauMinimo = grau;
				grauMinimoNome = $(v).text();
			}else {
				if (grau > grauMaximo) {
					grauMaximo = grau
					grauMaximoNome = $(v).text();
				}

				if (grau < grauMinimo) {
					grauMinimo = grau;
					grauMinimoNome = $(v).text();
				}
			}
		});
		
		grauMedio = grauMedio / $('#grau select[name="vertices"] option').length;		

		alert('Grau máximo: ' + grauMaximoNome + ' - ' + grauMaximo + '\r\nGrau mínimo: ' + grauMinimoNome + ' - ' + grauMinimo + '\r\nGrau médio: ' + grauMedio);
	}

	function clearVariables() {
		verificacao = '';
		adjacentesStart = '';
		adjacentes = '';
	}

	function gerarGrafo() {
		var canvas = document.getElementById('canvas');
		var context = canvas.getContext('2d');
		context.clearRect(0, 0, canvas.width, canvas.height);

		var N = vertices;

        var X = new Array(N);
        var Y = new Array(N);

        var texto = 'A';

        for (var i = 0; i < N; i++) {

			var x = Math.random() * canvas.width;
			var y = Math.random() * canvas.height;
			
			var c_x = 0,
			c_y = 0;

			if (x >= (canvas.width * 0.97))
				c_x = canvas.width - 50;
			else if (x <= (canvas.width * 0.05))
				c_x = 50;
			else
				c_x = x;

			if (y >= (canvas.height * 0.97))
				c_y = canvas.height - 50;
			else if (y <= (canvas.height * 0.05))
				c_y = 50;
			else
				c_y = y;			
			
			X[i] = c_x;
			Y[i] = c_y;

			var cor = "#000";
			if (adjacentes.indexOf(i) >= 0)
				cor = '#ff0000';

			$("canvas").drawArc({
				strokeStyle: cor,
				strokeWidth: 2,
				x: c_x, 
				y: c_y,
				radius: 12
            }).drawText({
				fillStyle: "#000",
				strokeWidth: 2,
				x: c_x, 
				y: c_y,
				font: "10pt Verdana, sans-serif",
				text: texto
          	});

          	texto = nextChar(texto);

        }

        if (arestas.length > 0) {
			
        	var plotagemArestas = arestas.split(',');
        	var inseridas = '';

        	for (var c = 0; c < (plotagemArestas.length - 1); c++) {
        		var plotagemVertices = plotagemArestas[c].split('.');

        		if (plotagemVertices[0] == plotagemVertices[1]) {
        			var cor = '#000';
					if (verificacao.indexOf(plotagemArestas[c]) >= 0) 
						cor = '#ff0000';

        			var k = c + 1;

        			$("canvas").rotateCanvas({
						rotate: 135,
						x: X[plotagemVertices[0]], 
						y: Y[plotagemVertices[0]] - 5
                    }).drawArc({
                        strokeStyle: cor,
                        strokeWidth: 1,
                        x: X[plotagemVertices[0]], 
                        y: Y[plotagemVertices[0]] - 5,
                        radius: 15,
                        start: 90, 
                        end: 1
                    }).restoreCanvas();

                }else {                	

                  	var arestaVerificacao = plotagemVertices[1] + '.' + plotagemVertices[0],
                  	x1 = X[plotagemVertices[0]],
                  	y1 = Y[plotagemVertices[0]],
                  	x2 = X[plotagemVertices[1]],
                  	y2 = Y[plotagemVertices[1]];
                  	
                  	if (inseridas.indexOf(arestaVerificacao) >= 0){
                  		y1 += 10;
                  		y2 += 10;
                  	}

                  	var cor = '#000';
					if (verificacao.indexOf(plotagemArestas[c]) >= 0) 
						cor = '#ff0000';

					$("canvas").drawLine({
						strokeStyle: cor,
						strokeWidth: 2,
						rounded: true,
						x1: x1, 
						y1: y1,
						x2: x2, 
						y2: y2,
					});

					inseridas += plotagemArestas[c] + ',';
                  }
        	}

        }
	}

	function nextChar(c) {
	    return String.fromCharCode(c.charCodeAt(0) + 1);
	}

	function euler() {
		clearVariables();

		var conexo = verificarGrafoConexo(true);

		if (!conexo)
			alert('Não existe caminho de Euler');
		else {
			var grausImpares = 0;

			var verificacaoArestas = arestas.split(',');
			$('#grau select[name="vertices"] option').each(function(i, v) {
				var grauStart = $(v).prop('value');
				var grau = 0;
				
				for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
					grau += getGrauByAresta(verificacaoArestas[c], grauStart);
				}

				if (grau % 2 != 0)
					grausImpares++;
			});
			
			if (grausImpares == 0 || grausImpares == 2)
				alert('Existe caminho de Euler');
			else
				alert('Não existe caminho de Euler');
		}
	}

	function matriz() {
		clearVariables();
		$('#tblIncidencias').remove();

		var vertices = new Array();

		$('#grau select[name="vertices"] option').each(function(i, v) {
			vertices.push(v.value + "");
		});

		var matriz = new Array();
		var header = '<th></th>';
		var body = '';
		
		for (var i = 0; i < vertices.length; i++) {
			matriz[i] = new Array();
			header += '<th>' + $('#grau select[name="vertices"] option[value="' + vertices[i] + '"]').text() + '</th>';
			body += '<tr><td>' + $('#grau select[name="vertices"] option[value="' + vertices[i] + '"]').text() + '</td>';
			for (var j = 0; j < vertices.length; j++) {
				var aresta1 = vertices[i] + '.' + vertices[j];
				var aresta2 = vertices[j] + '.' + vertices[i];

				var total = 0;
				if (arestas.indexOf(aresta1) >= 0)
					total++;

				if (aresta1 != aresta2) {
					if (arestas.indexOf(aresta2) >= 0)
						total++;
				}
				
				body += '<td>' + total + '</td>';
			}
			body += '</tr>';
		}

		var retorno = '<table id="tblIncidencias" border="1" cellspacing="0" colspacing="0">' +
		'<thead><tr>' + header + '</tr></thead>' +
		'<tbody>' + body + '</tbody' +
		'</table>';
		
		$('#incidencias').append(retorno);
	}

	var leitor = new FileReader();

	window.onload = function init() {
		leitor.onload = lerArquivo;
	}

	function pegaArquivo(inputFile) {
		var file = inputFile.files[0];
	 	leitor.readAsText(file);
	}

	function lerArquivo(evt) {
		var linhas = evt.target.result.split('\n');
		
		if (linhas.length > 2) {
			alert('Arquivo mal formatado!');
		}else {
			if (linhas.length > 1) {
				if (!$.isNumeric(linhas[0])){
					alert('Número de vértices não encontrado!');
					return;
				}else
					vertices = linhas[0]

				var verificacaoArestas = linhas[1].split(',');
				
				for (var i = 0; i < (verificacaoArestas.length - 1); i++) {
					var verificacaoVertices = verificacaoArestas[i].split('.');
					
					if (verificacaoVertices.length != 2) { 
						alert('Vertice ' + verificacaoArestas[i] + ' mal formatado');
						return;
					}else {
						if (!$.isNumeric(verificacaoVertices[0]) || !$.isNumeric(verificacaoVertices[1])) {
							alert('Vertice ' + verificacaoArestas[i] + ' mal formatado');
							return;
						} else {
							if ((verificacaoVertices[0] < 0 || verificacaoVertices[0] > (vertices - 1)) || (verificacaoVertices[1] < 0 || verificacaoVertices[1] > (vertices - 1))) {
								alert('Vertice ' + verificacaoArestas[i] + ' mal formatado');
								return;
							}else{
								arestas = linhas[1];
								matriz();
								gerarGrafo();
							}
						}
					}
				}
			}
		}
	}

	function getGrauByAresta(aresta, start) {
		var partes = aresta.split('.');

		var grau = 0;

		if (partes[0] == start)
			grau++;
		if (partes[1] == start)
			grau++;

		return grau;
	}

	function inserirVertice() {
		clearVariables();

		vertices++;
		gerarGrafo();

		var texto = 'A';

		$('select').each(function(i, v) {
			$(v).children().remove();
		});

		for (var i = 0; i < vertices; i++) {
			$('select').append('<option value="' + i + '">' + texto +'</option>')
			texto = nextChar(texto);
		}

		$('.requisito').show();
		matriz();
	}

	function inserirAresta(vertice1, vertice2) {
		clearVariables();

		var nome = vertice1 + '.' + vertice2;
		
		if (arestas.indexOf(nome) < 0) {
			arestas += nome + ',';
			gerarGrafo();
		} else
			alert('Aresta já existe no grafo');

		matriz();
	}

	function removerVertice(vertice) {
		clearVariables();

		var verificacaoArestas = arestas.split(',');
		
		for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
			var partes = verificacaoArestas[c].split('.');
			
			if (partes[0] == vertice || partes[1] == vertice){
				var find = verificacaoArestas[c] + ',';
				var re = new RegExp(find, 'g');
				arestas = arestas.replace(re, '');
			}
		}

		vertices--;

		if (vertices == 0)
			$('.requisito').hide();

		gerarGrafo();

		matriz();
	}

	function removerAresta(vertice1, vertice2) {
		clearVariables();

		var aresta1 = vertice1 + '.' + vertice2;
		var aresta2 = vertice2 + '.' + vertice1;

		var find = aresta1 + ',';
		var re = new RegExp(find, 'g');
		arestas = arestas.replace(re, '');

		var find = aresta2 + ',';
		var re = new RegExp(find, 'g');
		arestas = arestas.replace(re, '');

		gerarGrafo();

		matriz();
	}

	function verificarExistencia(vertice1, vertice2) {
		clearVariables();

		var nomeVerificacao1 = vertice1 + '.' + vertice2;
		var nomeVerificacao2 = vertice2 + '.' + vertice1;
		
		var existe = false;

		if (arestas.indexOf(nomeVerificacao1) >= 0) {
			verificacao += nomeVerificacao1 + ',';
			existe = true;
		}

		if (arestas.indexOf(nomeVerificacao2) >= 0) {
			verificacao += nomeVerificacao2 + ',';
			existe = true;
		}

		if (!existe)
			alert('Não existe aresta para os vértices pesquisados');
		else
			gerarGrafo();
	}

	function verificarAdjacentes(vertice, inner) {
		clearVariables();

		var verificacaoArestas = arestas.split(',');
		adjacentesStart = vertice;
		
		for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
			var partes = verificacaoArestas[c].split('.');

			if (partes[0] == adjacentesStart)
				adjacentes += partes[1] + ',';
			else if (partes[1] == adjacentesStart)
				adjacentes += partes[0] + ',';
		}

		if (!inner) {
			if (adjacentes == '') 
				alert('Não existem vértices adjacentes');
			else
				gerarGrafo();
		}else
			return adjacentes;
	}

	function verificarGrau(vertice) {
		clearVariables();

		var verificacaoArestas = arestas.split(',');
		var grauStart = vertice;
		var grau = 0;
		
		for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
			grau += getGrauByAresta(verificacaoArestas[c], grauStart);
		}

		var nome = $('#grau select[name="vertices"] option[value="' + grauStart + '"]').text();

		alert('O vértice ' + nome + ' possui grau ' + grau);
	}

	var visitados = new Array();
	function verificarGrafoConexo(inner) {
		visitados = new Array();
		var adjacencias = new Array();

		buscaFrofunda(0);

		var conexo = true;
		$('#grau select[name="vertices"] option').each(function(i, v) {
			if (!visitados[v.value])
				conexo = false;
		});	

		if (inner)
			return conexo;
		else{
			if (conexo)
				alert('Grafo conexo!')
			else
				alert('Grafo não conexo!')
		}
	}

	function buscaFrofunda(vertice) {
		visitados[vertice] = true;

		var adjacencias = verificarAdjacentes(vertice, true);
		adjacencias = adjacencias.split(',');
		
		for (var i = 0; i < (adjacencias.length - 1); i++) {
			if (!visitados[adjacencias[i]])
				buscaFrofunda(adjacencias[i]);
		}
	}
          
</script>