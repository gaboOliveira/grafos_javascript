<html>
	<head>
		<title>Grafos</title>
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="resources/css/app.css">
		<script type="text/javascript" src="resources/libraries/jquery.js"></script>
		<script type="text/javascript" src="resources/libraries/jcanvas.js"></script>
		<script src="resources/libraries/bootstrap-3.3.5/js/bootstrap.min.js"></script>
		<link href="resources/libraries/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet">
	</head>
	<body>

		<br />

		<div id="alertas"></div>

		<div class="panel-group col-lg-4" id="accordion" role="tablist" aria-multiselectable="true">
			<div class="panel panel-default">
				<div class="panel-heading" role="tab" id="headingOne">
					<h4 class="panel-title">
						<a data-parent="#accordion">
							Grafos
						</a>
					</h4>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading" role="tab" id="headingOne">
					<h4 class="panel-title">
						<a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
							Vértice
						</a>
					</h4>
				</div>
				<div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
					<div class="panel-body">
						<div class="col-sm-1">
							<input type="button" class="btn btn-primary" id="inserirVertice" value="Incluir">
						</div>
						<div class="clearfix"></div>
						<div class="requisito">
							<hr />
							<div class="col-sm-3">
								<label>Vértices:</label>
								<select class="form-control" name="vertices"></select>
							</div>
							<div class="clearfix"></div>
							<br />
							<div class="col-sm-3">
								<input class="btn btn-danger" type="button" id="removerVertice" value="Remover">
							</div>
							<div class="col-sm-4">
								<input class="btn btn-info" type="button" id="verificarAdjacentes" value="Adjacências">
							</div>
							<div class="col-sm-3" style="margin-left: -13px;">
								<input class="btn btn-warning" type="button" id="verificarGrau" value="Grau">
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading" role="tab" id="headingThree">
					<h4 class="panel-title">
						<a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
							Árquivo
						</a>
					</h4>
				</div>
				<div id="collapseThree" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingThree">
					<div class="panel-body">
						<label>
							<input type="file" id="inserirArquivo" value="Add" onchange="pegaArquivo(this)">
						</label>
					</div>
				</div>
			</div>
			<div class="panel panel-default requisito">
				<div class="panel-heading" role="tab" id="headingTwo">
					<h4 class="panel-title">
						<a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
							Aresta
						</a>
					</h4>
				</div>
				<div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
					<div class="panel-body">
						<div class="col-sm-3" style="margin-left: -16px;">
							<label for="vertice1" id="vertice1">Vértice 1</label>
							<select class="form-control" name="vertice1"></select>
						</div>
						<div class="col-sm-3">
							<label for="vertice2">Vértice 2</label>
							<select class="form-control" name="vertice2" id="vertice2"></select>
						</div>
						<div class="clearfix"></div>
						<hr />
						<div class="col-sm-4" style="margin-left: -16px;">
							<input class="btn btn-primary" type="button" id="inserirAresta" value="Incluir Aresta">
						</div>
						<div class="col-sm-5" style="margin-left: -7px;">
							<input class="btn btn-danger" type="button" id="remvoerAresta" value="Remover Aresta">
						</div>
						<div class="col-sm-3" style="margin-left: -19px;">
							<input class="btn btn-warning" type="button" id="verificarExistencia" value="Verificar Aresta">
						</div>
					</div>
				</div>
			</div>
			<div class="panel panel-default requisito">
				<div class="panel-heading" role="tab" id="headingFour">
					<h4 class="panel-title">
						<a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
							Funções
						</a>
					</h4>
				</div>
				<div id="collapseFour" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingFour">
					<div class="panel-body">
						<input class="btn btn-primary" type="button" id="verificarGraus" value="Obter Graus">
						<div class="clearfix"></div>
						<br />
						<input class="btn btn-success" type="button" id="verificarEuler" value="Verificar caminho de Euler">
						<div class="clearfix"></div>
						<br />
						<input class="btn btn-success" type="button" id="verificarGrafoConexo" value="Verificar grafo Conexo">
						<div class="clearfix"></div>
						<br />
						<div id="incidencias">
							<label>Matriz de Adjacências</label>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="plotagem">
			<canvas id="canvas" width="1000" height="500" ></canvas>
		</div>

	</body>

</html>

<script type="text/javascript">

	var vertices = 0;
	var arestas = '';
	var verificacao = '';
	var adjacentes = '';
	var adjacentesStart = '';
	var leitor = new FileReader();
	var visitados = new Array();

	$('.requisito').hide();

	$('#inserirVertice').on('click', function() {
		inserirVertice();
	});

	function inserirVertice() {
		clearVariables();

		vertices++;
		gerarGrafo();

		var texto = 'A';

		$('select').each(function(i, v) {
			$(v).children().remove();
		});

		for (var i = 0; i < vertices; i++) {
			$('select').append('<option value="' + i + '">' + texto +'</option>')
			texto = nextChar(texto);
		}

		$('.requisito').show();
		matriz();
	}

	$('#removerVertice').on('click', function() {
		removerVertice($('select[name="vertices"]').val());
	});

	function removerVertice(vertice) {
		clearVariables();

		var verificacaoArestas = arestas.split(',');
		
		for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
			var partes = verificacaoArestas[c].split('.');
			
			if (partes[0] == vertice || partes[1] == vertice){
				var find = verificacaoArestas[c] + ',';
				var re = new RegExp(find, 'g');
				arestas = arestas.replace(re, '');
			}
		}

		vertices--;

		if (vertices == 0)
			$('.requisito').hide();

		gerarGrafo();

		matriz();
	}

	$('#inserirAresta').on('click', function() {
		inserirAresta($('select[name="vertice1"]').val(), $('select[name="vertice2"]').val());
	});

	function inserirAresta(vertice1, vertice2) {
		clearVariables();

		var nome = vertice1 + '.' + vertice2;
		
		if (arestas.indexOf(nome) < 0) {
			arestas += nome + ',';
			gerarGrafo();
		} else {
			$('#alertas').html('');
			var alerta = '' +
				'<div class="alert alert-danger alert-dismissible" role="alert">'+
					'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
					'<strong>Atenção!</strong> Aresta já existe no grafo'+
				'</div>';
			$('#alertas').html(alerta);
		}

		matriz();
	}

	$('#remvoerAresta').on('click', function() {
		removerAresta($('select[name="vertice1"]').val(), $('select[name="vertice2"]').val());
	});

	function removerAresta(vertice1, vertice2) {
		clearVariables();

		var aresta1 = vertice1 + '.' + vertice2;
		var aresta2 = vertice2 + '.' + vertice1;
		console.log(aresta1);
		console.log(aresta2);
		console.log(arestas);
		var find = aresta1 + ',';
		var re = new RegExp(find, 'g');
		arestas = arestas.replace(re, '');

		var find = aresta2 + ',';
		var re = new RegExp(find, 'g');
		arestas = arestas.replace(re, '');

		gerarGrafo();

		matriz();
	}

	$('#verificarExistencia').on('click', function() {
		verificarExistencia($('select[name="vertice1"]').val(), $('select[name="vertice2"]').val());
	});	

	function verificarExistencia(vertice1, vertice2) {
		clearVariables();

		var nomeVerificacao1 = vertice1 + '.' + vertice2;
		var nomeVerificacao2 = vertice2 + '.' + vertice1;
		
		var existe = false;

		if (arestas.indexOf(nomeVerificacao1) >= 0) {
			verificacao += nomeVerificacao1 + ',';
			existe = true;
		}

		if (arestas.indexOf(nomeVerificacao2) >= 0) {
			verificacao += nomeVerificacao2 + ',';
			existe = true;
		}

		if (!existe) {
			$('#alertas').html('');
			var alerta = '' +
				'<div class="alert alert-danger alert-dismissible" role="alert">'+
					'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
					'<strong>Atenção!</strong> Não existe aresta para os vértices pesquisados'+
				'</div>';
			$('#alertas').html(alerta);
		} else
			gerarGrafo();
	}

	$('#verificarAdjacentes').on('click', function() {
		verificarAdjacentes($('select[name="vertices"]').val(), false);
	});

	function verificarAdjacentes(vertice, inner) {
		clearVariables();

		var verificacaoArestas = arestas.split(',');
		adjacentesStart = vertice;
		
		for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
			var partes = verificacaoArestas[c].split('.');

			if (partes[0] == adjacentesStart)
				adjacentes += partes[1] + ',';
			else if (partes[1] == adjacentesStart)
				adjacentes += partes[0] + ',';
		}

		if (!inner) {
			if (adjacentes == '') {
				$('#alertas').html('');
				var alerta = '' +
					'<div class="alert alert-danger alert-dismissible" role="alert">'+
						'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
						'<strong>Atenção!</strong> Não existem vértices adjacentes'+
					'</div>';
				$('#alertas').html(alerta);
			} else
				gerarGrafo();
		}else
			return adjacentes;
	}

	$('#verificarGrau').on('click', function() {
		verificarGrau($('select[name="vertices"]').val());
	});

	function verificarGrau(vertice) {
		clearVariables();

		var verificacaoArestas = arestas.split(',');
		var grauStart = vertice;
		var grau = 0;
		
		for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
			grau += getGrauByAresta(verificacaoArestas[c], grauStart);
		}

		var nome = $('select[name="vertices"] option[value="' + grauStart + '"]').text();

		$('#alertas').html('');
		var alerta = '' +
			'<div class="alert alert-info alert-dismissible" role="alert">'+
				'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
				'<strong>Atenção!</strong> O vértice ' + nome + ' possui grau ' + grau+
			'</div>';
		$('#alertas').html(alerta);
	}

	$('#verificarGraus').on('click', function() {
		verificarGraus();
	});

	function verificarGraus() {
		clearVariables();

		var grauMaximo = 0;
		var grauMaximoNome = '';

		var grauMinimo = 100;
		var grauMinimoNome = '';

		var grauMedio = 0;

		var verificacaoArestas = arestas.split(',');
		$('select[name="vertices"] option').each(function(i, v) {
			var grauStart = $(v).prop('value');
			var grau = 0;
			
			for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
				grau += getGrauByAresta(verificacaoArestas[c], grauStart);
			}

			grauMedio += grau;

			if (i == 0) {
				grauMaximo = grau;
				grauMaximoNome = $(v).text();

				grauMinimo = grau;
				grauMinimoNome = $(v).text();
			}else {
				if (grau > grauMaximo) {
					grauMaximo = grau
					grauMaximoNome = $(v).text();
				}

				if (grau < grauMinimo) {
					grauMinimo = grau;
					grauMinimoNome = $(v).text();
				}
			}
		});
		
		grauMedio = grauMedio / $('select[name="vertices"] option').length;		

		var alerta = '' +
			'<div class="alert alert-info alert-dismissible" role="alert">'+
				'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
				'<strong>Atenção!</strong> Grau máximo: ' + grauMaximoNome + ' - ' + grauMaximo + 
					'\r\nGrau mínimo: ' + grauMinimoNome + ' - ' + grauMinimo + '\r\nGrau médio: ' + grauMedio +
			'</div>';
		$('#alertas').html(alerta);
	}

	$('#verificarEuler').on('click', function() {
		euler();
	});

	function euler() {
		clearVariables();

		var conexo = verificarGrafoConexo(true);

		if (!conexo) {
			var alerta = '' +
				'<div class="alert alert-danger alert-dismissible" role="alert">'+
					'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
					'<strong>Atenção!</strong> Não existe caminho de Euler' +
				'</div>';
			$('#alertas').html(alerta);
		} else {
			var grausImpares = 0;

			var verificacaoArestas = arestas.split(',');
			$('select[name="vertices"] option').each(function(i, v) {
				var grauStart = $(v).prop('value');
				var grau = 0;
				
				for (var c = 0; c < (verificacaoArestas.length - 1); c++) {
					grau += getGrauByAresta(verificacaoArestas[c], grauStart);
				}

				if (grau % 2 != 0)
					grausImpares++;
			});
			
			if (grausImpares == 0 || grausImpares == 2) {
				var alerta = '' +
					'<div class="alert alert-success alert-dismissible" role="alert">'+
						'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
						'<strong>Atenção!</strong> Existe caminho de Euler' +
					'</div>';
				$('#alertas').html(alerta);
			} else {
				var alerta = '' +
					'<div class="alert alert-danger alert-dismissible" role="alert">'+
						'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
						'<strong>Atenção!</strong> Não existe caminho de Euler' +
					'</div>';
				$('#alertas').html(alerta);
			}
		}
	}

	/*$('#gerarMatriz').on('click', function() {
		matriz();
	});*/

	function matriz() {
		clearVariables();
		$('#tblIncidencias').remove();

		var vertices = new Array();

		$('select[name="vertices"] option').each(function(i, v) {
			vertices.push(v.value + "");
		});

		var matriz = new Array();
		var header = '<th></th>';
		var body = '';
		
		for (var i = 0; i < vertices.length; i++) {
			matriz[i] = new Array();
			header += '<th>' + $('select[name="vertices"] option[value="' + vertices[i] + '"]').text() + '</th>';
			body += '<tr><td>' + $('select[name="vertices"] option[value="' + vertices[i] + '"]').text() + '</td>';
			for (var j = 0; j < vertices.length; j++) {
				var aresta1 = vertices[i] + '.' + vertices[j];
				var aresta2 = vertices[j] + '.' + vertices[i];

				var total = 0;
				if (arestas.indexOf(aresta1) >= 0)
					total++;

				if (aresta1 != aresta2) {
					if (arestas.indexOf(aresta2) >= 0)
						total++;
				}
				
				body += '<td>' + total + '</td>';
			}
			body += '</tr>';
		}

		var retorno = '<table class="table" id="tblIncidencias" border="1" cellspacing="0" colspacing="0">' +
		'<thead><tr>' + header + '</tr></thead>' +
		'<tbody>' + body + '</tbody' +
		'</table>';
		
		$('#incidencias').append(retorno);
	}

	$('#verificarGrafoConexo').on('click', function() {
		verificarGrafoConexo(false);
	});

	function verificarGrafoConexo(inner) {
		visitados = new Array();
		var adjacencias = new Array();

		buscaFrofunda(0);

		var conexo = true;
		$('select[name="vertices"] option').each(function(i, v) {
			if (!visitados[v.value])
				conexo = false;
		});	

		if (inner)
			return conexo;
		else{
			if (conexo) {
				var alerta = '' +
					'<div class="alert alert-success alert-dismissible" role="alert">'+
						'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
						'<strong>Atenção!</strong> Grafo conexo!' +
					'</div>';
				$('#alertas').html(alerta);
			} else {
				var alerta = '' +
					'<div class="alert alert-danger alert-dismissible" role="alert">'+
						'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
						'<strong>Atenção!</strong> Grafo não conexo!' +
					'</div>';
				$('#alertas').html(alerta);
			}
		}
	}

	function buscaFrofunda(vertice) {
		visitados[vertice] = true;

		var adjacencias = verificarAdjacentes(vertice, true);
		adjacencias = adjacencias.split(',');
		
		for (var i = 0; i < (adjacencias.length - 1); i++) {
			if (!visitados[adjacencias[i]])
				buscaFrofunda(adjacencias[i]);
		}
	}

	function clearVariables() {
		$('#alertas').html('');
		verificacao = '';
		adjacentesStart = '';
		adjacentes = '';
	}

	function gerarGrafo() {
		var canvas = document.getElementById('canvas');
		var context = canvas.getContext('2d');
		context.clearRect(0, 0, canvas.width, canvas.height);

		var N = vertices;

        var X = new Array(N);
        var Y = new Array(N);

        var texto = 'A';

        for (var i = 0; i < N; i++) {

			var x = Math.random() * canvas.width;
			var y = Math.random() * canvas.height;
			
			var c_x = 0,
			c_y = 0;

			if (x >= (canvas.width * 0.97))
				c_x = canvas.width - 50;
			else if (x <= (canvas.width * 0.05))
				c_x = 50;
			else
				c_x = x;

			if (y >= (canvas.height * 0.97))
				c_y = canvas.height - 50;
			else if (y <= (canvas.height * 0.05))
				c_y = 50;
			else
				c_y = y;			
			
			X[i] = c_x;
			Y[i] = c_y;

			var cor = "#000";
			if (adjacentes.indexOf(i) >= 0)
				cor = '#ff0000';

			$("canvas").drawArc({
				strokeStyle: cor,
				strokeWidth: 2,
				x: c_x, 
				y: c_y,
				radius: 12
            }).drawText({
				fillStyle: "#000",
				strokeWidth: 2,
				x: c_x, 
				y: c_y,
				font: "10pt Verdana, sans-serif",
				text: texto
          	});

          	texto = nextChar(texto);

        }

        if (arestas.length > 0) {
			
        	var plotagemArestas = arestas.split(',');
        	var inseridas = '';

        	for (var c = 0; c < (plotagemArestas.length - 1); c++) {
        		var plotagemVertices = plotagemArestas[c].split('.');

        		if (plotagemVertices[0] == plotagemVertices[1]) {
        			var cor = '#000';
					if (verificacao.indexOf(plotagemArestas[c]) >= 0) 
						cor = '#ff0000';

        			var k = c + 1;

        			$("canvas").rotateCanvas({
						rotate: 135,
						x: X[plotagemVertices[0]], 
						y: Y[plotagemVertices[0]] - 5
                    }).drawArc({
                        strokeStyle: cor,
                        strokeWidth: 1,
                        x: X[plotagemVertices[0]], 
                        y: Y[plotagemVertices[0]] - 5,
                        radius: 15,
                        start: 90, 
                        end: 1
                    }).restoreCanvas();

                }else {                	

                  	var arestaVerificacao = plotagemVertices[1] + '.' + plotagemVertices[0],
                  	x1 = X[plotagemVertices[0]],
                  	y1 = Y[plotagemVertices[0]],
                  	x2 = X[plotagemVertices[1]],
                  	y2 = Y[plotagemVertices[1]];
                  	
                  	if (inseridas.indexOf(arestaVerificacao) >= 0){
                  		y1 += 10;
                  		y2 += 10;
                  	}

                  	var cor = '#000';
					if (verificacao.indexOf(plotagemArestas[c]) >= 0) 
						cor = '#ff0000';

					$("canvas").drawLine({
						strokeStyle: cor,
						strokeWidth: 2,
						rounded: true,
						x1: x1, 
						y1: y1,
						x2: x2, 
						y2: y2,
					});

					inseridas += plotagemArestas[c] + ',';
                  }
        	}

        }
	}

	function nextChar(c) {
	    return String.fromCharCode(c.charCodeAt(0) + 1);
	}
	

	window.onload = function init() {
		leitor.onload = lerArquivo;
	}

	function pegaArquivo(inputFile) {
		var file = inputFile.files[0];
	 	leitor.readAsText(file);
	}

	function lerArquivo(evt) {
		clearVariables();
		var linhas = evt.target.result.split('\n');
		
		if (linhas.length > 2) {
			var alerta = '' +
				'<div class="alert alert-danger alert-dismissible" role="alert">'+
					'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
					'<strong>Atenção!</strong> Arquivo mal formatado!' +
				'</div>';
			$('#alertas').html(alerta);
		}else {
			if (linhas.length > 1) {
				if (!$.isNumeric(linhas[0])){
					var alerta = '' +
						'<div class="alert alert-danger alert-dismissible" role="alert">'+
							'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
							'<strong>Atenção!</strong> Número de vértices não encontrado!' +
						'</div>';
					$('#alertas').html(alerta);
					return;
				}else
					vertices = linhas[0]

				var verificacaoArestas = linhas[1].split(',');
				
				for (var i = 0; i < (verificacaoArestas.length - 1); i++) {
					var verificacaoVertices = verificacaoArestas[i].split('.');
					
					if (verificacaoVertices.length != 2) { 
						var alerta = '' +
							'<div class="alert alert-danger alert-dismissible" role="alert">'+
								'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
								'<strong>Atenção!</strong> Vertice ' + verificacaoArestas[i] + ' mal formatado' +
							'</div>';
						$('#alertas').html(alerta);
						return;
					}else {
						if (!$.isNumeric(verificacaoVertices[0]) || !$.isNumeric(verificacaoVertices[1])) {
							var alerta = '' +
								'<div class="alert alert-danger alert-dismissible" role="alert">'+
									'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
									'<strong>Atenção!</strong> Vertice ' + verificacaoArestas[i] + ' mal formatado' +
								'</div>';
							$('#alertas').html(alerta);
							return;
						} else {
							if ((verificacaoVertices[0] < 0 || verificacaoVertices[0] > (vertices - 1)) || (verificacaoVertices[1] < 0 || verificacaoVertices[1] > (vertices - 1))) {
								var alerta = '' +
									'<div class="alert alert-danger alert-dismissible" role="alert">'+
										'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
										'<strong>Atenção!</strong> Vertice ' + verificacaoArestas[i] + ' mal formatado' +
									'</div>';
								$('#alertas').html(alerta);
								return;
							}else{
								arestas = linhas[1];
								matriz();
								gerarGrafo();
							}
						}
					}
				}
			}
		}
	}

	function getGrauByAresta(aresta, start) {
		var partes = aresta.split('.');

		var grau = 0;

		if (partes[0] == start)
			grau++;
		if (partes[1] == start)
			grau++;

		return grau;
	}
          
</script>